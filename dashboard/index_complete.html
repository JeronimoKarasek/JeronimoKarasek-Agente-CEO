<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agente-CEO Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    .nav-link { @apply px-4 py-2 rounded hover:bg-gray-700 cursor-pointer transition; }
    .nav-link.active { @apply bg-indigo-600; }
    .section { @apply hidden; }
    .section.active { @apply block; }
    .input-field { @apply w-full p-2 rounded bg-gray-800 border border-gray-700 focus:border-indigo-500 focus:outline-none; }
    .btn-primary { @apply px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded font-medium transition; }
    .btn-secondary { @apply px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded font-medium transition; }
    .card { @apply bg-gray-800 p-6 rounded-lg shadow-lg; }
    .label { @apply block text-sm font-medium text-gray-300 mb-2; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  
  <!-- Header -->
  <header class="bg-gray-800 border-b border-gray-700">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-indigo-400">ğŸ¤– Agente-CEO</h1>
        <div id="user-info" class="text-sm text-gray-400"></div>
      </div>
    </div>
  </header>

  <div class="max-w-7xl mx-auto px-6 py-8">
    
    <!-- Navigation -->
    <nav class="flex gap-2 mb-8 bg-gray-800 p-4 rounded-lg">
      <div class="nav-link active" data-section="dashboard">ğŸ“Š Dashboard</div>
      <div class="nav-link" data-section="config">âš™ï¸ ConfiguraÃ§Ã£o</div>
      <div class="nav-link" data-section="operations">ğŸš€ OperaÃ§Ãµes</div>
      <div class="nav-link" data-section="monitoring">ğŸ“ˆ Monitoramento</div>
      <div class="nav-link" data-section="logs">ğŸ“‹ Logs</div>
    </nav>

    <!-- Dashboard Section -->
    <div id="dashboard" class="section active">
      <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="card">
          <div class="text-sm text-gray-400 mb-2">Receita Hoje</div>
          <div id="revenue-today" class="text-3xl font-bold text-green-400">R$ 0</div>
        </div>
        <div class="card">
          <div class="text-sm text-gray-400 mb-2">Tarefas na Fila</div>
          <div id="queue-count" class="text-3xl font-bold text-blue-400">0</div>
        </div>
        <div class="card">
          <div class="text-sm text-gray-400 mb-2">Status do Sistema</div>
          <div id="system-status" class="text-3xl font-bold text-yellow-400">...</div>
        </div>
      </div>

      <div class="card mb-6">
        <h3 class="text-xl font-semibold mb-4">AÃ§Ãµes RÃ¡pidas</h3>
        <div class="flex gap-3">
          <button onclick="quickScout()" class="btn-primary">ğŸ” Scout Produtos</button>
          <button onclick="refreshDashboard()" class="btn-secondary">ğŸ”„ Atualizar</button>
        </div>
      </div>

      <div class="card">
        <h3 class="text-xl font-semibold mb-4">Ãšltimas Atividades</h3>
        <div id="recent-activities" class="space-y-2 text-sm">
          <div class="text-gray-500">Carregando...</div>
        </div>
      </div>
    </div>

    <!-- Config Section -->
    <div id="config" class="section">
      <h2 class="text-3xl font-bold mb-6">âš™ï¸ ConfiguraÃ§Ã£o</h2>
      
      <!-- Supabase Config -->
      <div class="card mb-6">
        <h3 class="text-xl font-semibold mb-4 text-indigo-400">ğŸ—„ï¸ Supabase</h3>
        <div class="space-y-4">
          <div>
            <label class="label">Supabase URL</label>
            <input type="text" id="supabase-url" class="input-field" placeholder="https://seu-projeto.supabase.co">
          </div>
          <div>
            <label class="label">Supabase Anon Key</label>
            <input type="text" id="supabase-anon" class="input-field" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
          </div>
          <div>
            <label class="label">Supabase Service Key (Opcional)</label>
            <input type="password" id="supabase-service" class="input-field" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
          </div>
        </div>
      </div>

      <!-- Meta/Facebook Ads Config -->
      <div class="card mb-6">
        <h3 class="text-xl font-semibold mb-4 text-blue-400">ğŸ“˜ Meta/Facebook Ads</h3>
        <div class="space-y-4">
          <div>
            <label class="label">Access Token</label>
            <input type="password" id="meta-token" class="input-field" placeholder="EAAx...">
          </div>
          <div>
            <label class="label">Ad Account ID</label>
            <input type="text" id="meta-account" class="input-field" placeholder="act_123456789">
          </div>
          <div>
            <label class="label">Pixel ID</label>
            <input type="text" id="meta-pixel" class="input-field" placeholder="123456789">
          </div>
          <div>
            <label class="label">Instagram Business Account ID</label>
            <input type="text" id="instagram-account" class="input-field" placeholder="17841...">
          </div>
        </div>
      </div>

      <!-- TikTok Ads Config -->
      <div class="card mb-6">
        <h3 class="text-xl font-semibold mb-4 text-pink-400">ğŸµ TikTok Ads</h3>
        <div class="space-y-4">
          <div>
            <label class="label">Access Token</label>
            <input type="password" id="tiktok-token" class="input-field">
          </div>
          <div>
            <label class="label">Advertiser ID</label>
            <input type="text" id="tiktok-advertiser" class="input-field">
          </div>
          <div>
            <label class="label">Pixel ID</label>
            <input type="text" id="tiktok-pixel" class="input-field">
          </div>
        </div>
      </div>

      <!-- Application Settings -->
      <div class="card mb-6">
        <h3 class="text-xl font-semibold mb-4 text-green-400">ğŸ›ï¸ ConfiguraÃ§Ãµes da AplicaÃ§Ã£o</h3>
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <div>
              <label class="label">Modo AutomÃ¡tico</label>
              <p class="text-sm text-gray-500">Sistema roda automaticamente</p>
            </div>
            <input type="checkbox" id="auto-mode" class="w-6 h-6">
          </div>
          <div class="flex items-center justify-between">
            <div>
              <label class="label">Modo AprovaÃ§Ã£o</label>
              <p class="text-sm text-gray-500">Requer aprovaÃ§Ã£o manual</p>
            </div>
            <input type="checkbox" id="approval-mode" class="w-6 h-6">
          </div>
          <div class="flex items-center justify-between">
            <div>
              <label class="label">Dry Run (Teste)</label>
              <p class="text-sm text-gray-500">Simula sem executar de verdade</p>
            </div>
            <input type="checkbox" id="dry-run" class="w-6 h-6">
          </div>
          <div>
            <label class="label">Target ROAS</label>
            <input type="number" step="0.1" id="target-roas" class="input-field" placeholder="1.5">
          </div>
          <div>
            <label class="label">Budget Cap DiÃ¡rio (USD)</label>
            <input type="number" step="10" id="daily-cap" class="input-field" placeholder="300">
          </div>
          <div>
            <label class="label">Budget Cap Semanal (USD)</label>
            <input type="number" step="100" id="weekly-cap" class="input-field" placeholder="1500">
          </div>
        </div>
      </div>

      <!-- API URL Config -->
      <div class="card mb-6">
        <h3 class="text-xl font-semibold mb-4 text-yellow-400">ğŸ”— API URL</h3>
        <div>
          <label class="label">URL Base da API</label>
          <input type="text" id="api-url" class="input-field" placeholder="http://103.199.187.127:8080/api">
        </div>
      </div>

      <!-- Save Buttons -->
      <div class="flex gap-3">
        <button onclick="saveConfig()" class="btn-primary">ğŸ’¾ Salvar ConfiguraÃ§Ãµes</button>
        <button onclick="loadConfig()" class="btn-secondary">ğŸ”„ Recarregar</button>
        <button onclick="testConnection()" class="btn-secondary">ğŸ”Œ Testar ConexÃ£o</button>
      </div>

      <div id="config-status" class="mt-4 p-4 rounded hidden"></div>
    </div>

    <!-- Operations Section -->
    <div id="operations" class="section">
      <h2 class="text-3xl font-bold mb-6">ğŸš€ OperaÃ§Ãµes</h2>
      
      <div class="card mb-6">
        <h3 class="text-xl font-semibold mb-4">Scout de Produtos</h3>
        <div class="space-y-4">
          <input type="text" id="scout-term" class="input-field" placeholder="trending dropshipping product">
          <button onclick="runScout()" class="btn-primary">ğŸ” Executar Scout</button>
        </div>
      </div>

      <div class="card mb-6">
        <h3 class="text-xl font-semibold mb-4">Gerar Criativos</h3>
        <div class="space-y-4">
          <input type="text" id="product-id" class="input-field" placeholder="Product ID">
          <input type="number" id="variants-count" class="input-field" placeholder="NÃºmero de variantes" value="5">
          <button onclick="generateCreatives()" class="btn-primary">ğŸ¨ Gerar Criativos</button>
        </div>
      </div>

      <div class="card">
        <h3 class="text-xl font-semibold mb-4">Resultado</h3>
        <pre id="operations-output" class="bg-gray-900 p-4 rounded overflow-auto max-h-96 text-sm"></pre>
      </div>
    </div>

    <!-- Monitoring Section -->
    <div id="monitoring" class="section">
      <h2 class="text-3xl font-bold mb-6">ğŸ“ˆ Monitoramento</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="card">
          <h3 class="text-lg font-semibold mb-4">Status da Fila</h3>
          <div id="queue-info" class="text-sm">Carregando...</div>
        </div>
        <div class="card">
          <h3 class="text-lg font-semibold mb-4">MÃ©tricas do Sistema</h3>
          <div id="system-metrics" class="text-sm">Carregando...</div>
        </div>
      </div>

      <div class="card mb-6">
        <h3 class="text-xl font-semibold mb-4">Alertas Recentes</h3>
        <div id="alerts-list" class="space-y-2">Carregando...</div>
      </div>

      <button onclick="refreshMonitoring()" class="btn-primary">ğŸ”„ Atualizar Dados</button>
    </div>

    <!-- Logs Section -->
    <div id="logs" class="section">
      <h2 class="text-3xl font-bold mb-6">ğŸ“‹ Logs e Auditoria</h2>
      
      <div class="card">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold">Log de Auditoria</h3>
          <button onclick="refreshLogs()" class="btn-secondary">ğŸ”„ Atualizar</button>
        </div>
        <div id="audit-logs" class="bg-gray-900 p-4 rounded overflow-auto max-h-96 text-sm">
          Carregando logs...
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    // Configuration
    let API_BASE_URL = 'http://103.199.187.127:8080/api';
    
    // Load config from localStorage
    function loadStoredConfig() {
      const stored = localStorage.getItem('agente-ceo-config');
      if (stored) {
        const config = JSON.parse(stored);
        if (config.apiUrl) API_BASE_URL = config.apiUrl;
      }
    }
    loadStoredConfig();

    // Navigation
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', () => {
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        link.classList.add('active');
        document.getElementById(link.dataset.section).classList.add('active');
      });
    });

    // API Helper
    async function apiCall(endpoint, options = {}) {
      try {
        const url = endpoint.startsWith('http') ? endpoint : `${API_BASE_URL}${endpoint}`;
        const res = await fetch(url, {
          headers: { 'Content-Type': 'application/json' },
          ...options
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (err) {
        console.error('API Error:', err);
        throw err;
      }
    }

    // Save Configuration
    window.saveConfig = async function() {
      const status = document.getElementById('config-status');
      status.className = 'mt-4 p-4 rounded bg-blue-900 text-blue-200';
      status.textContent = 'ğŸ”„ Salvando configuraÃ§Ãµes...';
      status.classList.remove('hidden');
      
      const config = {
        workspace_id: 'default',
        supabase_url: document.getElementById('supabase-url').value || null,
        supabase_anon_key: document.getElementById('supabase-anon').value || null,
        supabase_service_key: document.getElementById('supabase-service').value || null,
        meta_access_token: document.getElementById('meta-token').value || null,
        meta_ad_account_id: document.getElementById('meta-account').value || null,
        meta_pixel_id: document.getElementById('meta-pixel').value || null,
        instagram_business_account_id: document.getElementById('instagram-account').value || null,
        tiktok_access_token: document.getElementById('tiktok-token').value || null,
        tiktok_advertiser_id: document.getElementById('tiktok-advertiser').value || null,
        tiktok_pixel_id: document.getElementById('tiktok-pixel').value || null,
        auto_mode: document.getElementById('auto-mode').checked,
        approval_mode: document.getElementById('approval-mode').checked,
        dry_run: document.getElementById('dry-run').checked,
        target_roas: parseFloat(document.getElementById('target-roas').value) || null,
        daily_budget_cap: parseFloat(document.getElementById('daily-cap').value) || null,
        weekly_budget_cap: parseFloat(document.getElementById('weekly-cap').value) || null
      };

      const apiUrl = document.getElementById('api-url').value;
      if (apiUrl) {
        API_BASE_URL = apiUrl;
      }

      try {
        // Salva no servidor
        const result = await apiCall('/admin/config', {
          method: 'POST',
          body: JSON.stringify(config)
        });
        
        // Salva localmente tambÃ©m (para URL da API)
        localStorage.setItem('agente-ceo-config', JSON.stringify({
          apiUrl: apiUrl
        }));
        
        status.className = 'mt-4 p-4 rounded bg-green-900 text-green-200';
        status.textContent = `âœ… ${result.message || 'ConfiguraÃ§Ãµes salvas com sucesso!'}`;
      } catch (err) {
        status.className = 'mt-4 p-4 rounded bg-red-900 text-red-200';
        status.textContent = `âŒ Erro ao salvar: ${err.message}`;
      }
      
      setTimeout(() => status.classList.add('hidden'), 5000);
    };

    // Load Configuration
    window.loadConfig = async function() {
      try {
        // Carrega do servidor
        const config = await apiCall('/admin/config');
        
        if (config.supabase_url && !config.supabase_url.includes('****')) 
          document.getElementById('supabase-url').value = config.supabase_url;
        if (config.supabase_anon_key && !config.supabase_anon_key.includes('****')) 
          document.getElementById('supabase-anon').value = config.supabase_anon_key;
        if (config.supabase_service_key && !config.supabase_service_key.includes('****')) 
          document.getElementById('supabase-service').value = config.supabase_service_key;
        
        if (config.meta_access_token && !config.meta_access_token.includes('****')) 
          document.getElementById('meta-token').value = config.meta_access_token;
        if (config.meta_ad_account_id) 
          document.getElementById('meta-account').value = config.meta_ad_account_id;
        if (config.meta_pixel_id) 
          document.getElementById('meta-pixel').value = config.meta_pixel_id;
        if (config.instagram_business_account_id) 
          document.getElementById('instagram-account').value = config.instagram_business_account_id;
        
        if (config.tiktok_access_token && !config.tiktok_access_token.includes('****')) 
          document.getElementById('tiktok-token').value = config.tiktok_access_token;
        if (config.tiktok_advertiser_id) 
          document.getElementById('tiktok-advertiser').value = config.tiktok_advertiser_id;
        if (config.tiktok_pixel_id) 
          document.getElementById('tiktok-pixel').value = config.tiktok_pixel_id;
        
        document.getElementById('auto-mode').checked = config.auto_mode || false;
        document.getElementById('approval-mode').checked = config.approval_mode || false;
        document.getElementById('dry-run').checked = config.dry_run || false;
        
        if (config.target_roas) 
          document.getElementById('target-roas').value = config.target_roas;
        if (config.daily_budget_cap) 
          document.getElementById('daily-cap').value = config.daily_budget_cap;
        if (config.weekly_budget_cap) 
          document.getElementById('weekly-cap').value = config.weekly_budget_cap;
        
        // Carrega URL da API do localStorage
        const stored = localStorage.getItem('agente-ceo-config');
        if (stored) {
          const localConfig = JSON.parse(stored);
          if (localConfig.apiUrl) {
            document.getElementById('api-url').value = localConfig.apiUrl;
          }
        }
        
        console.log('ConfiguraÃ§Ãµes carregadas do servidor');
      } catch (err) {
        console.error('Erro ao carregar configuraÃ§Ãµes:', err);
      }
    };

    // Test Connection
    window.testConnection = async function() {
      const status = document.getElementById('config-status');
      status.className = 'mt-4 p-4 rounded bg-blue-900 text-blue-200';
      status.textContent = 'ğŸ”„ Testando conexÃ£o...';
      status.classList.remove('hidden');
      
      try {
        const data = await apiCall('/metrics/summary');
        status.className = 'mt-4 p-4 rounded bg-green-900 text-green-200';
        status.textContent = 'âœ… ConexÃ£o OK! API respondendo corretamente.';
      } catch (err) {
        status.className = 'mt-4 p-4 rounded bg-red-900 text-red-200';
        status.textContent = `âŒ Erro na conexÃ£o: ${err.message}`;
      }
    };

    // Dashboard Functions
    window.refreshDashboard = async function() {
      try {
        const metrics = await apiCall('/metrics/summary');
        document.getElementById('revenue-today').textContent = `R$ ${metrics.revenue || 0}`;
        
        const queue = await apiCall('/admin/queue');
        document.getElementById('queue-count').textContent = queue.queued || 0;
        
        document.getElementById('system-status').textContent = 'ğŸŸ¢ Online';
        document.getElementById('system-status').className = 'text-3xl font-bold text-green-400';
      } catch (err) {
        document.getElementById('system-status').textContent = 'ğŸ”´ Offline';
        document.getElementById('system-status').className = 'text-3xl font-bold text-red-400';
      }
    };

    // Operations
    window.runScout = async function() {
      const term = document.getElementById('scout-term').value || 'trending product';
      const output = document.getElementById('operations-output');
      output.textContent = 'Executando scout...';
      
      try {
        const data = await apiCall('/run/scout', {
          method: 'POST',
          body: JSON.stringify({ search_term: term })
        });
        output.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        output.textContent = `Erro: ${err.message}`;
      }
    };

    window.generateCreatives = async function() {
      const productId = document.getElementById('product-id').value;
      const variants = document.getElementById('variants-count').value || 5;
      const output = document.getElementById('operations-output');
      
      if (!productId) {
        output.textContent = 'Por favor, insira um Product ID';
        return;
      }
      
      output.textContent = 'Gerando criativos...';
      
      try {
        const data = await apiCall(`/run/creatives/${productId}?variants=${variants}`, {
          method: 'POST'
        });
        output.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        output.textContent = `Erro: ${err.message}`;
      }
    };

    window.quickScout = function() {
      document.querySelector('[data-section="operations"]').click();
      setTimeout(() => document.getElementById('scout-term').focus(), 100);
    };

    // Monitoring
    window.refreshMonitoring = async function() {
      try {
        const queue = await apiCall('/admin/queue');
        document.getElementById('queue-info').innerHTML = `<div class="text-2xl font-bold">${queue.queued}</div><div class="text-gray-400">tarefas na fila</div>`;
        
        const config = await apiCall('/admin/config');
        document.getElementById('system-metrics').innerHTML = `
          <div class="space-y-1">
            <div>Auto Mode: <span class="font-bold">${config.AUTO_MODE ? 'âœ… Sim' : 'âŒ NÃ£o'}</span></div>
            <div>Approval Mode: <span class="font-bold">${config.APPROVAL_MODE ? 'âœ… Sim' : 'âŒ NÃ£o'}</span></div>
            <div>Dry Run: <span class="font-bold">${config.DRY_RUN ? 'âœ… Sim' : 'âŒ NÃ£o'}</span></div>
            <div>Target ROAS: <span class="font-bold">${config.TARGET_ROAS}</span></div>
          </div>
        `;
        
        const alerts = await apiCall('/admin/alerts');
        if (alerts.length === 0) {
          document.getElementById('alerts-list').innerHTML = '<div class="text-gray-500">Nenhum alerta recente</div>';
        } else {
          document.getElementById('alerts-list').innerHTML = alerts.map(a => 
            `<div class="p-3 bg-gray-900 rounded"><span class="font-bold">${a.severity}:</span> ${a.message}</div>`
          ).join('');
        }
      } catch (err) {
        console.error('Erro ao atualizar monitoramento:', err);
      }
    };

    // Logs
    window.refreshLogs = async function() {
      try {
        const audit = await apiCall('/admin/audit');
        if (audit.length === 0) {
          document.getElementById('audit-logs').textContent = 'Nenhum log de auditoria disponÃ­vel';
        } else {
          document.getElementById('audit-logs').textContent = JSON.stringify(audit, null, 2);
        }
      } catch (err) {
        document.getElementById('audit-logs').textContent = `Erro ao carregar logs: ${err.message}`;
      }
    };

    // Init
    loadConfig();
    refreshDashboard();
    
    // Auto-refresh dashboard every 30s
    setInterval(refreshDashboard, 30000);
  </script>
</body>
</html>
